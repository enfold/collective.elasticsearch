from collective.elasticsearch.indexes import getIndex
from pyes import (MatchAllQuery, ANDFilter, FilteredQuery)
from pyes import HighLighter
from pyes import Search

class QueryAssembler(object):

    def __init__(self, catalogtool):
        self.catalogtool = catalogtool
        self.request = catalogtool.REQUEST

    def normalize(self, query):
        sort_on = ['_score']
        sort = query.pop('sort_on', None)
        if sort:
            sort_on.extend(sort.split(','))
        sort_order = query.pop('sort_order', 'ascending')
        if sort_on:
            sortstr = ','.join(sort_on)
            if sort_order in ('descending', 'reverse', 'desc'):
                sortstr += ':desc'
            else:
                sortstr += ':asc'
        else:
            sortstr = ''
        if 'b_size' in query:
            del query['b_size']
        if 'b_start' in query:
            del query['b_start']
        if 'sort_limit' in query:
            del query['sort_limit']
        return query, sortstr

    def __call__(self, dquery):
        filters = []
        catalog = self.catalogtool._catalog
        idxs = catalog.indexes.keys()
        query = MatchAllQuery()
        for key, value in dquery.items():
            if key not in idxs:
                continue
            index = getIndex(catalog, key)
            if index is None:
                continue
            qq = index.get_query(key, value)
            if qq is None:
                continue
            if type(qq) == tuple:
                qq, is_query = qq
            else:
                is_query = False
            if is_query:
                query = qq
            else:
                filters.append(qq)
        if len(filters) != 0:
            query = FilteredQuery(query, ANDFilter(filters))

        if 'SearchableText' in dquery:
            hl = HighLighter(pre_tags=['<b>'], post_tags=['</b>'])
            hl.add_field('SearchableText')
            return Search(query, highlight=hl)
        else:
            return query
